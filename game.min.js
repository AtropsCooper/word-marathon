const canvasWidth=414,canvasHeight=448;var canvasScale=1;const bgWidth=1398,bgHeight=466;var bgScale=.7;const stageScale=.95,wordBgColor=["#5bb2d0","#e4c36a","#f2741f"];var stage,loader,inputbox,loadText,carSpriteSheet,car,meterPointer,meterText,travelMapCar,dialogueContainer,dialogueWrapper,currentWordText,currentWordWrapper,acceleratingText,words=[],dialogues=[],dialoguesTriggered=[!1,!1],icons=["icon1","icon2","icon3","icon4"];const totalDistance=2e3;var currPosition=0,drivingSpeed=0,targetDrivingSpeed=0,targetDialogueY=0,intervalLastMove=0,bonus=0,isFinished=!1;const bgSequence=["city1.back","city2.back","rural1.back","rural2.back","seaside1.back","seaside2.back"],fgSequence=["city1.front","city2.front","rural1.front","rural2.front","seaside.front","seaside.front"];var bgContainer=new createjs.Container,fgContainer=new createjs.Container,sequenceCounter=0;function init(){stage=new createjs.Stage("gameCanvas",{antialias:!0}),createjs.Ticker.timingMode=createjs.Ticker.RAF_SYNCHED,createjs.Ticker.framerate=60,createjs.Ticker.addEventListener("tick",stage),window.addEventListener("resize",handleResize),handleResize();phase="city",(loader=new createjs.LoadQueue(!0)).setMaxConnections(8),loader.addEventListener("progress",handleProgress),loader.addEventListener("complete",handleComplete),(loadText=new createjs.Text("Loading...","26px sans-serif","#ffffff")).textAlign="center",loadText.x=canvasWidth/2,loadText.y=canvasHeight/2;var e=loadText.getBounds();loadText.cache(e.x-e.width,e.y,3*e.width,e.height),stage.addChild(loadText),loadWords(),loadDialogues(),loader.loadManifest([{src:"./src/car.png",id:"car"},{src:"./src/city1-back.png",id:"city1.back"},{src:"./src/city1-front.png",id:"city1.front"},{src:"./src/city2-back.png",id:"city2.back"},{src:"./src/city2-front.png",id:"city2.front"},{src:"./src/rural1-back.jpg",id:"rural1.back"},{src:"./src/rural1-front.png",id:"rural1.front"},{src:"./src/rural2-back.jpg",id:"rural2.back"},{src:"./src/rural2-front.png",id:"rural2.front"},{src:"./src/seaside1-back.png",id:"seaside1.back"},{src:"./src/seaside2-back.png",id:"seaside2.back"},{src:"./src/seaside-front.png",id:"seaside.front"},{src:"./src/pointer.png",id:"pointer"},{src:"./src/clock.png",id:"clock"},{src:"./src/travelmap.png",id:"travelmap"},{src:"./src/travelmapcar.png",id:"travelmapcar"},{src:"./src/icon1.png",id:"icon1"},{src:"./src/icon2.png",id:"icon2"},{src:"./src/icon3.png",id:"icon3"},{src:"./src/icon4.png",id:"icon4"},{src:"./src/finish.png",id:"finish"}],!0,"./"),stage.update()}function loadWords(){fetch("./src/words.json").then((e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()})).then((e=>{if(!Array.isArray(e))throw new Error("JSON data is not an array");words=e})).catch((e=>{console.error("Fetch error:",e)}))}function loadDialogues(){fetch("./src/dialogues.json").then((e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()})).then((e=>{if(!Array.isArray(e))throw new Error("JSON data is not an array");dialogues=e})).catch((e=>{console.error("Fetch error:",e)}))}function generateRandomWord(){const e=Math.floor(Math.random()*words.length),a=words[e].meaning,t=wordBgColor[words[e].attr-1];currentWordText=words[e].word;var r=new createjs.Text(a,"22px sans-serif","#000000");r.x=10,r.y=7;var n=r.getBounds();r.cache(n.x-2,n.y-2,n.width+4,n.height+4),null!=currentWordWrapper&&stage.removeChild(currentWordWrapper),currentWordWrapper=new createjs.Container,wordBg=new createjs.Shape,wordBg.graphics.beginFill(t).drawRoundRect(0,0,r.getMeasuredWidth()+10,34,10),wordBg.cache(0,0,r.getMeasuredWidth()+20,34),currentWordWrapper.addChild(wordBg),currentWordWrapper.addChild(r),currentWordWrapper.x=10*canvasScale,currentWordWrapper.y=(bgHeight+6)*bgScale,stage.addChild(currentWordWrapper)}function handleProgress(e){var a=e.progress,t="Loading: "+Math.round(100*a)+"%";loadText.text=t,loadText.updateCache()}function handleComplete(){stage.removeChild(loadText),createInput(),createBg(),createCar(),createFg(),createMeter(),createTravelMap(),generateRandomWord(),createDialogueBox(),createjs.Ticker.addEventListener("tick",handleTick)}function createInput(){var e=new createjs.Shape;e.graphics.beginFill("#EEEEEE").drawRect(0,0,window.innerWidth/stageScale,90),e.x=0,e.y=bgHeight*bgScale,e.cache(0,0,window.innerWidth/stageScale,90),stage.addChild(e),(inputbox=document.createElement("input")).type="text",inputbox.style.margin="0px",inputbox.style.position="fixed",inputbox.style.left="6px",inputbox.enterKeyHint="go",inputbox.onfocus=()=>{setTimeout((()=>{window.scrollTo(0,0)}),500)},resizeInputBox(),inputbox.onkeydown=handleEnter,document.body.appendChild(inputbox)}function resizeInputBox(){inputbox.style.top=canvasScale*(bgHeight+66)*bgScale+"px",inputbox.style.width=canvasWidth*canvasScale-13+"px",inputbox.style.fontSize=Math.round(20*canvasScale)+"px"}function createBg(){bgSequence.map(((e,a)=>{obj=new createjs.Bitmap(loader.getResult(e)),obj.x=a*bgWidth*bgScale,obj.y=0,obj.scale=bgScale,bgContainer.addChild(obj)})),bgContainer.x=0,bgContainer.y=0,stage.addChild(bgContainer)}function createFg(){fgSequence.map(((e,a)=>{obj1=new createjs.Bitmap(loader.getResult(e)),obj2=new createjs.Bitmap(loader.getResult(e)),obj1.x=2*a*bgWidth*bgScale,obj2.x=(2*a+1)*bgWidth*bgScale,obj1.y=0,obj2.y=0,obj1.scale=bgScale,obj2.scale=bgScale,fgContainer.addChild(obj1,obj2)})),fgContainer.x=0,fgContainer.y=0,stage.addChild(fgContainer)}function createCar(){var e={images:[loader.getResult("car")],frames:{width:600,height:400,count:33},framerate:20};carSpriteSheet=new createjs.SpriteSheet(e),(car=new createjs.Sprite(carSpriteSheet)).x=105,car.y=160*bgScale,car.scale=.35,stage.addChild(car),car.play()}function createMeter(){const e=84,a=95;var t=new createjs.Container;var r=new createjs.Shape;r.alpha=.25,r.graphics.beginFill("#399205").drawRoundRect(0,0,e,a,15),r.cache(0,0,e,a);var n=new createjs.Bitmap(loader.getResult("clock")),i=new createjs.Bitmap(loader.getResult("pointer"));i.scale=84/64,i.x=-42,i.y=-42,(meterPointer=new createjs.Container).addChild(i),meterPointer.x=42,meterPointer.y=42.5,n.x=0,n.y=0,n.scale=83/128;var c=new createjs.Text("KM/H","14px sans-serif","#FFFFFF");c.textAlign="center",c.shadow=new createjs.Shadow("#000000",1,1,2);var o=c.getBounds();c.cache(o.x,o.y,o.width,o.height),c.x=42,c.y=79,(meterText=new createjs.Text(Math.round(drivingSpeed).toString(),"28px sans-serif","#FFFFFF")).textAlign="center",meterText.x=42,meterText.y=.55*a,o=meterText.getBounds(),meterText.cache(o.x-o.width,o.y,3*o.width,o.height),(acceleratingText=new createjs.Text("加速中","20px sans-serif","#FFFFFF")).textAlign="center",o=acceleratingText.getBounds(),acceleratingText.cache(o.x,o.y,o.width,o.height),acceleratingText.x=42,acceleratingText.y=-24,t.addChild(r,c,meterText,acceleratingText,n,meterPointer),t.x=canvasWidth-e-10,t.y=bgHeight*bgScale-a-10,stage.addChild(t)}function updateMeter(){meterPointer.rotation=drivingSpeed/80*190-6,meterText.text=Math.round(drivingSpeed).toString(),meterText.updateCache(),acceleratingText.visible=bonus>0}function createTravelMap(){var e=new createjs.Container,a=new createjs.Bitmap(loader.getResult("travelmap"));(travelMapCar=new createjs.Bitmap(loader.getResult("travelmapcar"))).x=0,travelMapCar.y=6,e.addChild(a,travelMapCar),e.scale=.75,e.x=canvasWidth-288.75,e.y=10,stage.addChild(e)}function updateTravelMap(){travelMapCar.x=currPosition/totalDistance*340}function createDialogueBox(){dialogueContainer=new createjs.Container,dialogueWrapper=new createjs.Container,dialogueContainer.x=10,dialogueContainer.y=50,dialogueContainer.addChild(dialogueWrapper),stage.addChild(dialogueContainer)}function addDialogue(e){var a=new createjs.Container,t=new createjs.Bitmap(loader.getResult(icons[dialogues[e].icon-1]));t.scale=.5,t.cache(0,0,64,64),a.addChild(t);var r=new createjs.Text(dialogues[e].text,"15px sans-serif","#000000"),n=new createjs.Container,i=r.getBounds();r.cache(i.x-4,i.y-4,i.width+8,i.height+8);var c=new createjs.Shape;c.graphics.beginFill("#f3f3f3").drawRoundRect(0,0,i.width+20,i.height+10,10),c.alpha=.5,c.cache(0,0,i.width+20,i.height+10),r.textAlign="center",r.x=60,r.y=2,c.x=50,n.addChild(c,r),n.y=5,a.addChild(n),a.y=40*dialogueWrapper.numChildren,dialogueWrapper.addChild(a),targetDialogueY=-40*Math.max(0,dialogueWrapper.numChildren-3)}function scollDialogue(){dialogueWrapper.y+=.1*(targetDialogueY-dialogueWrapper.y),dialogueContainer.cache(0,0,300,150)}function showFinished(){if(!isFinished){isFinished=!0;var e=new createjs.Bitmap(loader.getResult("finish"));e.y=114,stage.addChild(e)}}function handleTick(e){currPosition+=e.delta/1e3*drivingSpeed,(drivingSpeed+=.1*(targetDrivingSpeed-drivingSpeed))>.2?carSpriteSheet.framerate=Math.round(Math.min(Math.max(10,.5*drivingSpeed),30)):car.stop(),currPosition<totalDistance*stageScale?(bgContainer.x=-(bgSequence.length*bgWidth*bgScale-canvasWidth*canvasScale)*(currPosition/totalDistance),fgContainer.x=-(2*bgSequence.length*bgWidth*bgScale-canvasWidth*canvasScale)*(currPosition/totalDistance)):(targetDrivingSpeed=0,drivingSpeed=0,showFinished()),intervalLastMove<=0?(bonus=0,targetDrivingSpeed=Math.max(0,targetDrivingSpeed-.01*e.delta)):intervalLastMove-=e.delta;for(let e=0,a=dialogues.length;e<a;++e)!dialoguesTriggered[e]&&dialogues[e].trigger/10<currPosition/totalDistance&&(dialoguesTriggered[e]=!0,dialogues[e].delay>0?setTimeout((()=>{addDialogue(e)}),1e3*dialogues[e].delay):addDialogue(e));updateMeter(),updateTravelMap(),scollDialogue()}function handleEnter(e){13==e.keyCode&&(currentWordText==inputbox.value&&(car.play(),targetDrivingSpeed=Math.min(80,targetDrivingSpeed+5+bonus),bonus=Math.min(35,bonus+5),intervalLastMove=4e3,generateRandomWord()),inputbox.value="")}function handleResize(e){let a=window.innerWidth,t=window.innerHeight;canvasScale=Math.min(1,a/canvasWidth),stage.scale=canvasScale,inputbox&&resizeInputBox();const r=Math.ceil(window.devicePixelRatio);width=Math.min(canvasWidth,a),height=Math.min(canvasHeight,t),stage.canvas.width=width*r,stage.canvas.height=height*r,stage.scale=r*stageScale,stage.canvas.style.width=`${width}px`,stage.canvas.style.height=`${height}px`,stage.update()}