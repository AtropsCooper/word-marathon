const canvasWidth=414,canvasHeight=448;var stage,loader,inputbox,loadText,car,meterPointer,meterText,travelMapCar,dialogueContainer,dialogueWrapper,currentWordText,currentWordWrapper,acceleratingText,canvasScale=1;const bgWidth=1398,bgHeight=466;var bgScale=.75;const wordBgColor=["#5bb2d0","#e4c36a","#f2741f"];var words=[],dialogues=[],dialoguesTriggered=[!1,!1],icons=["icon1","icon2","icon3","icon4"];const totalDistance=2e3;var currPosition=0,drivingSpeed=0,targetDrivingSpeed=0,targetDialogueY=0,intervalLastMove=0,bonus=0,isFinished=!1;const bgSequence=["city1.back","city2.back","rural1.back","rural2.back","seaside1.back","seaside2.back"],fgSequence=["city1.front","city2.front","rural1.front","rural2.front","seaside.front","seaside.front"];var bgContainer=new createjs.Container,fgContainer=new createjs.Container,sequenceCounter=0;function init(){(stage=new createjs.StageGL("gameCanvas",{antialias:!0})).setClearColor("#000000"),createjs.Ticker.timingMode=createjs.Ticker.RAF_SYNCHED,createjs.Ticker.framerate=60,createjs.Ticker.addEventListener("tick",stage),window.addEventListener("resize",handleResize),handleResize(),phase="city",(loader=new createjs.LoadQueue(!0)).setMaxConnections(8),loader.addEventListener("progress",handleProgress),loader.addEventListener("complete",handleComplete),(loadText=new createjs.Text("Loading...","26px sans-serif","#ffffff")).textAlign="center",loadText.x=207,loadText.y=224;var e=loadText.getBounds();loadText.cache(e.x-e.width,e.y,3*e.width,e.height),stage.addChild(loadText),loadWords(),loadDialogues(),loader.loadManifest([{src:"./src/car.png",id:"car"},{src:"./src/city1-back.png",id:"city1.back"},{src:"./src/city1-front.png",id:"city1.front"},{src:"./src/city2-back.png",id:"city2.back"},{src:"./src/city2-front.png",id:"city2.front"},{src:"./src/rural1-back.jpg",id:"rural1.back"},{src:"./src/rural1-front.png",id:"rural1.front"},{src:"./src/rural2-back.jpg",id:"rural2.back"},{src:"./src/rural2-front.png",id:"rural2.front"},{src:"./src/seaside1-back.png",id:"seaside1.back"},{src:"./src/seaside2-back.png",id:"seaside2.back"},{src:"./src/seaside-front.png",id:"seaside.front"},{src:"./src/pointer.png",id:"pointer"},{src:"./src/clock.png",id:"clock"},{src:"./src/travelmap.png",id:"travelmap"},{src:"./src/travelmapcar.png",id:"travelmapcar"},{src:"./src/icon1.png",id:"icon1"},{src:"./src/icon2.png",id:"icon2"},{src:"./src/icon3.png",id:"icon3"},{src:"./src/icon4.png",id:"icon4"},{src:"./src/finish.png",id:"finish"},],!0,"./"),stage.update()}function loadWords(){fetch("./src/words.json").then(e=>{if(!e.ok)throw Error(`HTTP error! Status: ${e.status}`);return e.json()}).then(e=>{if(!Array.isArray(e))throw Error("JSON data is not an array");words=e}).catch(e=>{console.error("Fetch error:",e)})}function loadDialogues(){fetch("./src/dialogues.json").then(e=>{if(!e.ok)throw Error(`HTTP error! Status: ${e.status}`);return e.json()}).then(e=>{if(!Array.isArray(e))throw Error("JSON data is not an array");dialogues=e}).catch(e=>{console.error("Fetch error:",e)})}function generateRandomWord(){let e=Math.floor(Math.random()*words.length),a=words[e].meaning,r=wordBgColor[words[e].attr-1];currentWordText=words[e].word;var t=new createjs.Text(a,"22px sans-serif","#000000");t.x=10,t.y=7;var n=t.getBounds();t.cache(n.x-2,n.y-2,n.width+4,n.height+4),null!=currentWordWrapper&&stage.removeChild(currentWordWrapper),currentWordWrapper=new createjs.Container,(wordBg=new createjs.Shape).graphics.beginFill(r).drawRoundRect(0,0,t.getMeasuredWidth()+10,34,10),wordBg.cache(0,0,t.getMeasuredWidth()+20,34),currentWordWrapper.addChild(wordBg),currentWordWrapper.addChild(t),currentWordWrapper.x=10*canvasScale,currentWordWrapper.y=472*bgScale,stage.addChild(currentWordWrapper)}function handleProgress(e){var a=e.progress;loadText.text="Loading: "+Math.round(100*a)+"%",loadText.updateCache()}function handleComplete(){stage.removeChild(loadText),createInput(),createBg(),createCar(),createFg(),createMeter(),createTravelMap(),generateRandomWord(),createDialogueBox(),createjs.Ticker.addEventListener("tick",handleTick)}function createInput(){var e=new createjs.Shape;e.graphics.beginFill("#EEEEEE").drawRect(0,0,414,80),e.x=0,e.y=466*bgScale,e.cache(0,0,414,80),stage.addChild(e),(inputbox=document.createElement("input")).type="text",inputbox.style.margin="0px",inputbox.style.position="fixed",inputbox.style.left="6px",resizeInputBox(),inputbox.onkeydown=handleEnter,document.body.appendChild(inputbox),inputbox.focus()}function resizeInputBox(){inputbox.style.top=552*canvasScale*bgScale+"px",inputbox.style.width=414*canvasScale-13+"px",inputbox.style.fontSize=Math.round(20*canvasScale)+"px"}function createBg(){bgSequence.map((e,a)=>{(obj=new createjs.Bitmap(loader.getResult(e))).x=1398*a*bgScale,obj.y=0,obj.scale=bgScale,bgContainer.addChild(obj)}),bgContainer.x=0,bgContainer.y=0,stage.addChild(bgContainer)}function createFg(){fgSequence.map((e,a)=>{obj1=new createjs.Bitmap(loader.getResult(e)),obj2=new createjs.Bitmap(loader.getResult(e)),obj1.x=2*a*1398*bgScale,obj2.x=(2*a+1)*1398*bgScale,obj1.y=0,obj2.y=0,obj1.scale=bgScale,obj2.scale=bgScale,fgContainer.addChild(obj1,obj2)}),fgContainer.x=0,fgContainer.y=0,stage.addChild(fgContainer)}function createCar(){(car=new createjs.Bitmap(loader.getResult("car"))).x=105,car.y=160*bgScale,car.scale=.35,stage.addChild(car)}function createMeter(){var e=new createjs.Container,a=new createjs.Shape;a.alpha=.25,a.graphics.beginFill("#399205").drawRoundRect(0,0,84,95,15),a.cache(0,0,84,95);var r=new createjs.Bitmap(loader.getResult("clock")),t=new createjs.Bitmap(loader.getResult("pointer"));t.scale=84/64,t.x=-42,t.y=-42,(meterPointer=new createjs.Container).addChild(t),meterPointer.x=42,meterPointer.y=42.5,r.x=0,r.y=0,r.scale=83/128;var n=new createjs.Text("KM/H","14px sans-serif","#FFFFFF");n.textAlign="center",n.shadow=new createjs.Shadow("#000000",1,1,2);var i=n.getBounds();n.cache(i.x,i.y,i.width,i.height),n.x=42,n.y=79,(meterText=new createjs.Text(Math.round(drivingSpeed).toString(),"28px sans-serif","#FFFFFF")).textAlign="center",meterText.x=42,meterText.y=52.25000000000001,i=meterText.getBounds(),meterText.cache(i.x-i.width,i.y,3*i.width,i.height),(acceleratingText=new createjs.Text("加速中","20px sans-serif","#FFFFFF")).textAlign="center",i=acceleratingText.getBounds(),acceleratingText.cache(i.x,i.y,i.width,i.height),acceleratingText.x=42,acceleratingText.y=-24,e.addChild(a,n,meterText,acceleratingText,r,meterPointer),e.x=320,e.y=466*bgScale-95-10,stage.addChild(e)}function updateMeter(){meterPointer.rotation=drivingSpeed/80*190-6,meterText.text=Math.round(drivingSpeed).toString(),meterText.updateCache(),bonus>0?acceleratingText.visible=!0:acceleratingText.visible=!1}function createTravelMap(){var e=new createjs.Container,a=new createjs.Bitmap(loader.getResult("travelmap"));(travelMapCar=new createjs.Bitmap(loader.getResult("travelmapcar"))).x=0,travelMapCar.y=6,e.addChild(a,travelMapCar),e.scale=.75,e.x=125.25,e.y=10,stage.addChild(e)}function updateTravelMap(){travelMapCar.x=currPosition/2e3*340}function createDialogueBox(){dialogueContainer=new createjs.Container,dialogueWrapper=new createjs.Container,dialogueContainer.x=10,dialogueContainer.y=50,dialogueContainer.addChild(dialogueWrapper),stage.addChild(dialogueContainer)}function addDialogue(e){var a=new createjs.Container,r=new createjs.Bitmap(loader.getResult(icons[dialogues[e].icon-1]));r.scale=.5,r.cache(0,0,64,64),a.addChild(r);var t=new createjs.Text(dialogues[e].text,"15px sans-serif","#000000"),n=new createjs.Container,i=t.getBounds();t.cache(i.x-4,i.y-4,i.width+8,i.height+8);var o=new createjs.Shape;o.graphics.beginFill("#f3f3f3").drawRoundRect(0,0,i.width+20,i.height+10,10),o.alpha=.5,o.cache(0,0,i.width+20,i.height+10),t.x=60,t.y=8,o.x=50,n.addChild(o,t),n.y=5,a.addChild(n),a.y=40*dialogueWrapper.numChildren,dialogueWrapper.addChild(a),targetDialogueY=-40*Math.max(0,dialogueWrapper.numChildren-3)}function scollDialogue(){dialogueWrapper.y+=(targetDialogueY-dialogueWrapper.y)*.1,dialogueContainer.cache(0,0,300,150)}function showFinished(){if(!isFinished){isFinished=!0;var e=new createjs.Bitmap(loader.getResult("finish"));e.y=124,stage.addChild(e)}}function handleTick(e){currPosition+=e.delta/1e3*drivingSpeed,drivingSpeed+=(targetDrivingSpeed-drivingSpeed)*.1,currPosition<2e3?(bgContainer.x=-(1398*bgSequence.length*bgScale-414*canvasScale)*(currPosition/2e3),fgContainer.x=-(2*bgSequence.length*1398*bgScale-414*canvasScale)*(currPosition/2e3)):(targetDrivingSpeed=0,drivingSpeed=0,showFinished()),intervalLastMove<=0?(bonus=0,targetDrivingSpeed=Math.max(0,targetDrivingSpeed-.01*e.delta)):intervalLastMove-=e.delta;for(let a=0,r=dialogues.length;a<r;++a)!dialoguesTriggered[a]&&dialogues[a].trigger/10<currPosition/2e3&&(dialoguesTriggered[a]=!0,dialogues[a].delay>0?setTimeout(()=>{addDialogue(a)},1e3*dialogues[a].delay):addDialogue(a));updateMeter(),updateTravelMap(),scollDialogue()}function handleEnter(e){13==e.keyCode&&(targetDrivingSpeed=Math.min(80,targetDrivingSpeed+5+bonus),bonus=Math.min(35,bonus+5),intervalLastMove=4e3,generateRandomWord(),inputbox.value="")}function handleResize(e){w=window.innerWidth,h=window.innerHeight,canvasScale=Math.min(1,w/414),stage.scale=canvasScale,inputbox&&resizeInputBox(),stage.canvas.width=Math.min(414,w),stage.updateViewport(Math.min(414,w),448),stage.update()}document.addEventListener("scroll",e=>{document.documentElement.scrollTop>100&&(document.documentElement.scrollTop=100)});